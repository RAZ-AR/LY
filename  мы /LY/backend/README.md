# LY Backend API

REST API backend –¥–ª—è iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è LY - —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Apple Wallet.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
cd backend
npm install
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
```bash
# –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
createdb ly_loyalty

# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏
npm run db:migrate
```

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
```bash
# Development —Ä–µ–∂–∏–º
npm run dev

# Production —Ä–µ–∂–∏–º
npm start
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:3000`

## üìö API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### Base URL
```
http://localhost:3000/api/v1
```

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### –ö–æ–º–ø–∞–Ω–∏–∏
- `GET /companies` - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏
- `GET /companies/:id` - –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é –ø–æ ID
- `POST /companies` - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é
- `PUT /companies/:id` - –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
- `DELETE /companies/:id` - –£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é

#### –ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- `GET /loyalty-programs` - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
- `GET /loyalty-programs/:id` - –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ ID
- `POST /loyalty-programs` - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
- `PUT /loyalty-programs/:id` - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É
- `DELETE /loyalty-programs/:id` - –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- `GET /users` - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `GET /users/:id` - –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
- `POST /users` - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `PUT /users/:id` - –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /users/:id/points` - –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤
- `POST /users/:id/points/add` - –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã
- `POST /users/:id/points/redeem` - –°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã
- `DELETE /users/:id` - –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### Apple Wallet –ø–∞—Å—Å—ã
- `GET /passes` - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–∞—Å—Å—ã
- `GET /passes/:id` - –ü–æ–ª—É—á–∏—Ç—å –ø–∞—Å—Å –ø–æ ID
- `POST /passes` - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Å—Å
- `PUT /passes/:id` - –û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Å—Å
- `GET /passes/:id/download` - –°–∫–∞—á–∞—Ç—å .pkpass —Ñ–∞–π–ª
- `DELETE /passes/:id` - –£–¥–∞–ª–∏—Ç—å –ø–∞—Å—Å

#### –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
- `GET /analytics/dashboard` - –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- `GET /analytics/company/:id` - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏
- `GET /analytics/loyalty-program/:id` - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

## üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
```bash
curl -X POST http://localhost:3000/api/v1/companies \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Coffee Shop",
    "adminEmail": "admin@coffeeshop.com",
    "logo": "https://example.com/logo.png"
  }'
```

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
curl -X POST http://localhost:3000/api/v1/users \
  -H "Content-Type: application/json" \
  -d '{
    "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
    "email": "ivan@example.com",
    "phone": "+7123456789",
    "birthday": "1990-01-01",
    "loyaltyProgramId": "program-uuid"
  }'
```

### –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
```bash
curl -X POST http://localhost:3000/api/v1/users/{user-id}/points/add \
  -H "Content-Type: application/json" \
  -d '{
    "points": 100,
    "description": "–ü–æ–∫—É–ø–∫–∞ –∫–æ—Ñ–µ"
  }'
```

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
- **companies** - –ö–æ–º–ø–∞–Ω–∏–∏
- **loyalty_programs** - –ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- **users** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- **loyalty_program_users** - –°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏
- **wallet_passes** - Apple Wallet –ø–∞—Å—Å—ã

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ly_loyalty
DB_USER=postgres
DB_PASSWORD=password

# Server
PORT=3000
NODE_ENV=development

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# API
API_BASE_URL=http://localhost:3000
MAX_FILE_SIZE=5242880
UPLOAD_DIR=uploads

# PassKit
PASS_TYPE_IDENTIFIER=pass.com.ly.loyalty
TEAM_IDENTIFIER=your-team-id
CERTIFICATE_PATH=./certificates/
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Rate limiting (100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 15 –º–∏–Ω—É—Ç)
- Helmet.js –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é Joi
- CORS –∑–∞—â–∏—Ç–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
npm test
```

## üì¶ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Node.js** - Runtime
- **Express.js** - Web framework
- **PostgreSQL** - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Knex.js** - Query builder
- **Joi** - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- **Multer** - –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
- **Helmet** - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **Morgan** - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

Backend –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º LY. –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

1. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
2. **–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** –∫–æ–º–ø–∞–Ω–∏–π –∏ –ø—Ä–æ–≥—Ä–∞–º–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
3. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –±–∞–ª–ª–∞–º–∏
4. **API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** Apple Wallet –ø–∞—Å—Å–æ–≤
5. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Apple PassKit —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ .pkpass —Ñ–∞–π–ª–æ–≤
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏